<!DOCTYPE html>
<html lang="zh-CN" :class="isDarkMode ? 'dark-theme' : 'light-theme'">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sentry消息监控中心</title>
    
    <!-- 基础样式 -->
    <link rel="stylesheet" href="styles.css">
    
    <!-- 引入Vue和ElementPlus -->
    <script src="https://cdn.bootcdn.net/ajax/libs/vue/3.3.4/vue.global.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/element-plus/2.3.14/index.full.js"></script>
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/element-plus/2.3.14/index.css">
    <script src="/socket.io/socket.io.js"></script>
    
    <style>
        /* 解决v-cloak闪烁问题 */
        [v-cloak] { 
            display: none !important; 
        }
    </style>
</head>
<body>
    <div id="app" v-cloak>
        <header class="app-header">
            <div class="header-content">
                <h1 class="main-title">Sentry消息监控中心</h1>
                <div class="header-actions">
                    <i 
                        :class="isDarkMode ? 'el-icon-sunny' : 'el-icon-moon'" 
                        class="theme-toggle"
                        @click="toggleTheme"
                        :title="isDarkMode ? '切换到浅色模式' : '切换到深色模式'"
                    ></i>
                </div>
            </div>
        </header>
        <main class="main-content">
            <div class="dashboard-container">
                <el-card class="status-card">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                <span class="status-dot" :class="{'status-connected': isConnected, 'status-disconnected': !isConnected}"></span>
                                <span style="margin-right: 20px;">{{ isConnected ? '已连接' : '连接断开' }}</span>
                                <el-tag size="small" type="success">共接收 {{ messages.length }} 条消息</el-tag>
                                <el-tag v-if="searchQuery" size="small" type="warning" style="margin-left: 10px;">
                                    搜索结果: {{ filteredMessages.length }} 条
                                </el-tag>
                                <el-tag v-if="messageInfo" size="small" type="info" style="margin-left: 10px;">
                                    文件大小: {{ messageInfo.currentFile?.size || '0 KB' }}
                                </el-tag>
                            </div>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px;">
                                <el-tooltip content="错误类型消息数量" placement="top">
                                    <el-tag type="danger" size="small">
                                        错误: {{ messageTypeStats.error }}
                                    </el-tag>
                                </el-tooltip>
                                <el-tooltip content="警告类型消息数量" placement="top">
                                    <el-tag type="warning" size="small">
                                        警告: {{ messageTypeStats.warning }}
                                    </el-tag>
                                </el-tooltip>
                                <el-tooltip content="信息类型消息数量" placement="top">
                                    <el-tag type="success" size="small">
                                        信息: {{ messageTypeStats.info }}
                                    </el-tag>
                                </el-tooltip>
                                <el-tooltip content="调试类型消息数量" placement="top">
                                    <el-tag type="info" size="small">
                                        调试: {{ messageTypeStats.debug }}
                                    </el-tag>
                                </el-tooltip>
                                <el-tooltip content="其他类型消息数量" placement="top">
                                    <el-tag size="small">
                                        其他: {{ messageTypeStats.other }}
                                    </el-tag>
                                </el-tooltip>
                            </div>
                            <div class="info-box" v-if="!isConnected">
                                <i class="el-icon-warning"></i> 连接已断开，请点击"重新连接"按钮恢复连接
                            </div>
                        </div>
                        <div class="action-buttons">
                            <el-button type="primary" @click="reconnectSocket" :loading="isReconnecting">
                                <i class="el-icon-refresh"></i> 重新连接
                            </el-button>
                            <el-button type="primary" @click="runTestMessages">
                                <i class="el-icon-video-play"></i> 发送测试消息
                            </el-button>
                            <el-button type="danger" @click="clearMessages" :disabled="messages.length === 0">
                                <i class="el-icon-delete"></i> 清空消息
                            </el-button>
                            <el-dropdown @command="handleCommand">
                                <el-button type="primary">
                                    <span>更多操作</span>
                                    <i class="el-icon-arrow-down el-icon--right"></i>
                                </el-button>
                                <template #dropdown>
                                    <el-dropdown-menu>
                                        <el-dropdown-item command="download">
                                            <i class="el-icon-download"></i> 下载消息
                                        </el-dropdown-item>
                                        <el-dropdown-item command="info">
                                            <i class="el-icon-info"></i> 存储信息
                                        </el-dropdown-item>
                                        <el-dropdown-item command="configApi">
                                            <i class="el-icon-key"></i> 配置AI接口
                                        </el-dropdown-item>
                                        <el-dropdown-item command="refresh" divided>
                                            <i class="el-icon-refresh"></i> 刷新消息
                                        </el-dropdown-item>
                                    </el-dropdown-menu>
                                </template>
                            </el-dropdown>
                        </div>
                    </div>
                </el-card>
                
                <el-collapse v-model="activeCollapse">
                    <el-collapse-item title="消息筛选与搜索" name="filters">
                        <el-card style="margin-bottom: 20px;">
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                <div class="filter-header">
                                    <div style="font-weight: bold; font-size: 15px;">消息类型筛选:</div>
                                    <el-button type="text" @click="resetTypeFilters" size="small">重置筛选</el-button>
                                </div>
                                <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                                    <el-button-group>
                                        <el-button 
                                            :type="selectedMessageTypes.includes('all') ? 'primary' : 'default'" 
                                            @click="selectedMessageTypes = ['all']; applyTypeFilters(['all'])">
                                            <span style="display: flex; align-items: center; gap: 5px;">
                                                <i class="el-icon-s-grid"></i> 全部类型
                                                <el-tag type="info" size="small" effect="plain">{{ messages.length }}</el-tag>
                                            </span>
                                        </el-button>
                                        
                                        <!-- 日志消息筛选 -->
                                        <el-button 
                                            v-if="messageTypeStats.error > 0"
                                            :type="selectedMessageTypes.includes('error') ? 'primary' : 'default'" 
                                            @click="selectedMessageTypes = ['error']; applyTypeFilters(['error'])">
                                            <span style="display: flex; align-items: center; gap: 5px;">
                                                <i class="el-icon-error"></i>
                                                <el-tag type="danger" size="small" effect="dark">错误</el-tag>
                                                <el-tag type="danger" size="small" effect="plain">{{ messageTypeStats.error }}</el-tag>
                                            </span>
                                        </el-button>
                                        
                                        <!-- 警告消息筛选 -->
                                        <el-button 
                                            v-if="messageTypeStats.warning > 0"
                                            :type="selectedMessageTypes.includes('warning') ? 'primary' : 'default'" 
                                            @click="selectedMessageTypes = ['warning']; applyTypeFilters(['warning'])">
                                            <span style="display: flex; align-items: center; gap: 5px;">
                                                <i class="el-icon-warning"></i>
                                                <el-tag type="warning" size="small" effect="dark">警告</el-tag>
                                                <el-tag type="warning" size="small" effect="plain">{{ messageTypeStats.warning }}</el-tag>
                                            </span>
                                        </el-button>
                                        
                                        <!-- 信息消息筛选 -->
                                        <el-button 
                                            v-if="messageTypeStats.info > 0"
                                            :type="selectedMessageTypes.includes('info') ? 'primary' : 'default'" 
                                            @click="selectedMessageTypes = ['info']; applyTypeFilters(['info'])">
                                            <span style="display: flex; align-items: center; gap: 5px;">
                                                <i class="el-icon-info"></i>
                                                <el-tag type="success" size="small" effect="dark">信息</el-tag>
                                                <el-tag type="success" size="small" effect="plain">{{ messageTypeStats.info }}</el-tag>
                                            </span>
                                        </el-button>
                                        
                                        <!-- 调试消息筛选 -->
                                        <el-button 
                                            v-if="messageTypeStats.debug > 0"
                                            :type="selectedMessageTypes.includes('debug') ? 'primary' : 'default'" 
                                            @click="selectedMessageTypes = ['debug']; applyTypeFilters(['debug'])">
                                            <span style="display: flex; align-items: center; gap: 5px;">
                                                <i class="el-icon-aim"></i>
                                                <el-tag type="info" size="small" effect="dark">调试</el-tag>
                                                <el-tag type="info" size="small" effect="plain">{{ messageTypeStats.debug }}</el-tag>
                                            </span>
                                        </el-button>
                                        
                                        <!-- 其他类型消息筛选 -->
                                        <el-button 
                                            v-if="messageTypeStats.other > 0"
                                            :type="selectedMessageTypes.includes('other') ? 'primary' : 'default'" 
                                            @click="selectedMessageTypes = ['other']; applyTypeFilters(['other'])">
                                            <span style="display: flex; align-items: center; gap: 5px;">
                                                <i class="el-icon-more"></i>
                                                <el-tag size="small" effect="dark">其他</el-tag>
                                                <el-tag size="small" effect="plain">{{ messageTypeStats.other }}</el-tag>
                                            </span>
                                        </el-button>
                                    </el-button-group>
                                </div>
                                
                                <div v-if="filteredMessages.length !== messages.length" class="filter-info">
                                    <i class="el-icon-info"></i> 已筛选，当前显示 {{ filteredMessages.length }}/{{ messages.length }} 条消息
                                    <el-button type="text" @click="resetTypeFilters" size="small">清除筛选</el-button>
                                </div>
                            </div>
                        </el-card>
                        
                        <el-card style="margin-bottom: 20px;" v-if="messages.length > 0">
                            <div style="display: flex; align-items: center;" class="search-box">
                                <el-input
                                    v-model="searchQuery"
                                    placeholder="搜索消息内容..."
                                    clearable
                                    style="flex: 1; margin-right: 10px;"
                                    @clear="clearSearch"
                                    @keyup.enter="searchMessages"
                                >
                                    <template #prefix>
                                        <i class="el-icon-search"></i>
                                    </template>
                                </el-input>
                                <el-select v-model="searchField" placeholder="搜索字段" style="width: 140px; margin-right: 10px;">
                                    <el-option label="全部字段" value="all"></el-option>
                                    <el-option label="事件类型" value="eventType"></el-option>
                                    <el-option label="项目" value="project"></el-option>
                                    <el-option label="日志消息" value="message"></el-option>
                                    <el-option label="异常类型" value="exceptionType"></el-option>
                                </el-select>
                                <el-button type="primary" @click="searchMessages">
                                    搜索
                                </el-button>
                            </div>
                        </el-card>
                    </el-collapse-item>
                </el-collapse>
                
                <div class="message-list-header" v-if="filteredMessages.length > 0">
                    <!-- 批量操作工具栏 -->
                    <div class="batch-actions-toolbar">
                        <el-checkbox 
                            v-model="selectAll" 
                            @change="toggleSelectAll"
                            :indeterminate="selectedMessages.length > 0 && selectedMessages.length < filteredMessages.length"
                        >
                            全选
                        </el-checkbox>
                        
                        <div class="batch-actions">
                            <span v-if="selectedMessages.length > 0" class="selection-info">
                                已选择 {{ selectedMessages.length }} 条消息
                            </span>
                            
                            <el-button 
                                type="danger" 
                                size="small" 
                                icon="el-icon-delete" 
                                :disabled="selectedMessages.length === 0"
                                @click="batchDelete"
                            >
                                批量删除
                            </el-button>
                            
                            <el-button 
                                type="primary" 
                                size="small" 
                                icon="el-icon-cpu" 
                                :disabled="selectedMessages.length === 0"
                                @click="batchAnalyze"
                            >
                                批量分析
                            </el-button>
                        </div>
                    </div>
                    
                    <el-row :gutter="20" style="font-weight: bold; padding: 10px 0; background-color: #f9f9f9; border-radius: 4px; margin-bottom: 15px;">
                        <el-col :span="3">类型</el-col>
                        <el-col :span="7">时间</el-col>
                        <el-col :span="14">详情</el-col>
                    </el-row>
                </div>
                
                <div class="message-list">
                    <template v-if="filteredMessages.length > 0">
                        <transition-group name="fade" tag="div" mode="out-in">
                            <el-card 
                                v-for="(message, index) in paginatedMessages" 
                                :key="message.id || index" 
                                class="message-card"
                                :class="{'message-card-new': message.isNew, 
                                        'message-card-error': message.level === 'error' || message.level === 'fatal' || (message.eventType === '错误事件' && message.level !== 'info'),
                                        'message-card-warning': message.level === 'warning' || (message.eventType === '问题事件' && message.level !== 'error' && message.level !== 'info'),
                                        'message-card-info': message.level === 'info' || message.eventType === '信息事件',
                                        'message-card-debug': message.level === 'debug'
                                        }"
                                :shadow="message.isNew ? 'hover' : 'never'"
                            >
                                <el-row :gutter="20" style="align-items: flex-start;">
                                    <el-col :span="3">
                                        <div style="display: flex; align-items: flex-start;">
                                            <!-- 添加消息选择框 -->
                                            <el-checkbox 
                                                v-model="message.selected" 
                                                @change="updateSelectedMessages"
                                                style="margin-right: 8px; margin-top: 3px;"
                                            ></el-checkbox>
                                            
                                            <div class="message-title">
                                                <el-tag 
                                                    size="small" 
                                                    :type="message.level && message.level.toLowerCase() === 'info' ? 'success' : getTagType(message)"
                                                    effect="dark"
                                                >
                                                    {{ message.level && message.level.toLowerCase() === 'info' ? '信息事件' : message.eventType }}
                                                </el-tag>
                                                <el-tag 
                                                    v-if="message.level" 
                                                    size="small" 
                                                    :type="message.level && message.level.toLowerCase() === 'info' ? 'success' : getTagType(message)"
                                                    style="margin-top: 5px;"
                                                >
                                                    {{ message.level }}
                                                </el-tag>
                                            </div>
                                        </div>
                                    </el-col>
                                    <el-col :span="4">
                                        <div class="message-time">
                                            <div>
                                                <el-tooltip :content="formatTime(message.timestamp)" placement="top">
                                                    <span class="timestamp">{{ getRelativeTime(message.timestamp) }}</span>
                                                </el-tooltip>
                                            </div>
                                            <div class="message-id">
                                                ID: {{ message.eventId || message.issueId || '未知' }}
                                            </div>
                                        </div>
                                    </el-col>
                                    <el-col :span="17">
                                        <!-- 错误事件内容 -->
                                        <div v-if="message.eventType === '错误事件'" class="message-content">
                                            <div class="property-grid">
                                                <!-- 左侧列：项目、异常类型、异常详情 -->
                                                <div class="property-col left-col">
                                                    <div class="property-item">
                                                        <div class="property-label">项目:</div>
                                                        <div class="property-value" v-html="renderHighlightedHTML(message.project, searchQuery)"></div>
                                                    </div>
                                                    <div class="property-item">
                                                        <div class="property-label">异常类型:</div>
                                                        <div class="property-value" v-html="renderHighlightedHTML(message.exceptionType, searchQuery)"></div>
                                                    </div>
                                                    <div class="property-item">
                                                        <div class="property-label">异常详情:</div>
                                                        <div class="property-value" v-html="renderHighlightedHTML(message.exceptionValue, searchQuery)"></div>
                                                    </div>
                                                </div>
                                                
                                                <!-- 右侧列：日志消息 -->
                                                <div class="property-col right-col">
                                                    <div class="property-item full-width">
                                                        <div class="property-label">日志消息:</div>
                                                        <div class="property-value message-text" v-html="renderHighlightedHTML(message.message, searchQuery)"></div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- AI分析按钮 -->
                                            <el-button 
                                                class="analyze-btn" 
                                                type="primary" 
                                                size="small" 
                                                icon="el-icon-cpu" 
                                                @click="analyzeMessage(message)"
                                                :disabled="message.isAnalyzing"
                                                :loading="message.isAnalyzing"
                                            >
                                                AI分析
                                            </el-button>
                                            
                                            <!-- AI分析结果 -->
                                            <div v-if="message.analysisResult" class="analysis-container">
                                                <div class="analysis-header">
                                                    <div class="analysis-title">
                                                        <i class="el-icon-cpu"></i> AI分析结果
                                                    </div>
                                                    <el-button 
                                                        type="text" 
                                                        icon="el-icon-close" 
                                                        @click="clearAnalysis(message)"
                                                    ></el-button>
                                                </div>
                                                
                                                <!-- 分析摘要 -->
                                                <div class="analysis-summary">
                                                    {{ getSummary(message.analysisResult) }}
                                                </div>
                                                
                                                <!-- 使用折叠面板展示分析结果 -->
                                                <el-collapse v-model="activeCollapse" accordion>
                                                    <!-- 主要分析结果 -->
                                                    <el-collapse-item title="主要分析结果" name="main">
                                                        <div class="analysis-content" v-html="formatContent(message.analysisResult.explanation || message.analysisResult.reason || '')"></div>
                                                    </el-collapse-item>
                                                    
                                                    <!-- 根本原因分析 -->
                                                    <el-collapse-item v-if="message.analysisResult.rootCauseAnalysis" title="根本原因分析" name="rootCause">
                                                        <div class="analysis-content" v-html="formatContent(message.analysisResult.rootCauseAnalysis)"></div>
                                                    </el-collapse-item>
                                                    
                                                    <!-- 代码修复建议 -->
                                                    <el-collapse-item v-if="message.analysisResult.codeFixSuggestion" title="代码修复建议" name="codeFix">
                                                        <div class="analysis-content code-fix" v-html="formatContent(message.analysisResult.codeFixSuggestion)"></div>
                                                    </el-collapse-item>
                                                    
                                                    <!-- 解决方案 -->
                                                    <el-collapse-item v-if="message.analysisResult.solution" title="解决方案" name="solution">
                                                        <div class="analysis-content" v-html="formatContent(message.analysisResult.solution)"></div>
                                                    </el-collapse-item>
                                                    
                                                    <!-- 预防措施 -->
                                                    <el-collapse-item v-if="message.analysisResult.prevention" title="预防措施" name="prevention">
                                                        <div class="analysis-content" v-html="formatContent(message.analysisResult.prevention)"></div>
                                                    </el-collapse-item>
                                                </el-collapse>
                                                
                                                <div v-if="message.isAnalyzing" class="loading-overlay">
                                                    <el-loading></el-loading>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- 问题事件内容 -->
                                        <div v-else-if="message.eventType === '问题事件'" class="message-content">
                                            <div class="property-grid">
                                                <!-- 左侧列：标题和来源 -->
                                                <div class="property-col left-col">
                                                    <div class="property-item">
                                                        <div class="property-label">标题:</div>
                                                        <div class="property-value" v-html="renderHighlightedHTML(message.title, searchQuery)"></div>
                                                    </div>
                                                    <div class="property-item">
                                                        <div class="property-label">来源:</div>
                                                        <div class="property-value" v-html="renderHighlightedHTML(message.culprit, searchQuery)"></div>
                                                    </div>
                                                </div>
                                                
                                                <!-- 右侧列：动作 -->
                                                <div class="property-col right-col">
                                                    <div class="property-item full-width">
                                                        <div class="property-label">动作:</div>
                                                        <div class="property-value message-text" v-html="renderHighlightedHTML(message.action, searchQuery)"></div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- AI分析按钮 -->
                                            <el-button 
                                                class="analyze-btn" 
                                                type="primary" 
                                                size="small" 
                                                icon="el-icon-cpu" 
                                                @click="analyzeMessage(message)"
                                                :disabled="message.isAnalyzing"
                                                :loading="message.isAnalyzing"
                                            >
                                                AI分析
                                            </el-button>
                                            
                                            <!-- AI分析结果 -->
                                            <div v-if="message.analysisResult" class="analysis-container">
                                                <div class="analysis-header">
                                                    <div class="analysis-title">
                                                        <i class="el-icon-cpu"></i> AI分析结果
                                                    </div>
                                                    <el-button 
                                                        type="text" 
                                                        icon="el-icon-close" 
                                                        @click="clearAnalysis(message)"
                                                    ></el-button>
                                                </div>
                                                
                                                <!-- 分析摘要 -->
                                                <div class="analysis-summary">
                                                    {{ getSummary(message.analysisResult) }}
                                                </div>
                                                
                                                <!-- 使用折叠面板展示分析结果 -->
                                                <el-collapse v-model="activeCollapse" accordion>
                                                    <!-- 主要分析结果 -->
                                                    <el-collapse-item title="主要分析结果" name="main">
                                                        <div class="analysis-content" v-html="formatContent(message.analysisResult.explanation || message.analysisResult.reason || '')"></div>
                                                    </el-collapse-item>
                                                    
                                                    <!-- 根本原因分析 -->
                                                    <el-collapse-item v-if="message.analysisResult.rootCauseAnalysis" title="根本原因分析" name="rootCause">
                                                        <div class="analysis-content" v-html="formatContent(message.analysisResult.rootCauseAnalysis)"></div>
                                                    </el-collapse-item>
                                                    
                                                    <!-- 代码修复建议 -->
                                                    <el-collapse-item v-if="message.analysisResult.codeFixSuggestion" title="代码修复建议" name="codeFix">
                                                        <div class="analysis-content code-fix" v-html="formatContent(message.analysisResult.codeFixSuggestion)"></div>
                                                    </el-collapse-item>
                                                    
                                                    <!-- 解决方案 -->
                                                    <el-collapse-item v-if="message.analysisResult.solution" title="解决方案" name="solution">
                                                        <div class="analysis-content" v-html="formatContent(message.analysisResult.solution)"></div>
                                                    </el-collapse-item>
                                                    
                                                    <!-- 预防措施 -->
                                                    <el-collapse-item v-if="message.analysisResult.prevention" title="预防措施" name="prevention">
                                                        <div class="analysis-content" v-html="formatContent(message.analysisResult.prevention)"></div>
                                                    </el-collapse-item>
                                                </el-collapse>
                                                
                                                <div v-if="message.isAnalyzing" class="loading-overlay">
                                                    <el-loading></el-loading>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- 其他类型消息 -->
                                        <div v-else class="message-content">
                                            <pre>{{ JSON.stringify(message, null, 2) }}</pre>
                                            
                                            <!-- AI分析按钮 -->
                                            <el-button 
                                                class="analyze-btn" 
                                                type="primary" 
                                                size="small" 
                                                icon="el-icon-cpu" 
                                                @click="analyzeMessage(message)"
                                                :disabled="message.isAnalyzing"
                                                :loading="message.isAnalyzing"
                                            >
                                                AI分析
                                            </el-button>
                                            
                                            <!-- AI分析结果 -->
                                            <div v-if="message.analysisResult" class="analysis-container">
                                                <div class="analysis-header">
                                                    <div class="analysis-title">
                                                        <i class="el-icon-cpu"></i> AI分析结果
                                                    </div>
                                                    <el-button 
                                                        type="text" 
                                                        icon="el-icon-close" 
                                                        @click="clearAnalysis(message)"
                                                    ></el-button>
                                                </div>
                                                
                                                <!-- 分析摘要 -->
                                                <div class="analysis-summary">
                                                    {{ getSummary(message.analysisResult) }}
                                                </div>
                                                
                                                <!-- 信息类型消息分析结果 -->
                                                <div v-if="message.level === 'info'" class="analysis-content">
                                                    <!-- 使用折叠面板展示信息类型分析结果 -->
                                                    <el-collapse v-model="activeCollapse" accordion>
                                                        <el-collapse-item title="日志解释" name="explanation">
                                                            <div v-html="formatContent(message.analysisResult.explanation)"></div>
                                                        </el-collapse-item>
                                                        <el-collapse-item title="是否正常" name="isNormal">
                                                            <div v-html="formatContent(message.analysisResult.isNormal)"></div>
                                                        </el-collapse-item>
                                                        <el-collapse-item title="是否需要关注" name="attention">
                                                            <div v-html="formatContent(message.analysisResult.attention)"></div>
                                                        </el-collapse-item>
                                                    </el-collapse>
                                                </div>
                                                
                                                <!-- 其他类型消息分析结果 -->
                                                <div v-else class="analysis-content">
                                                    <!-- 使用折叠面板展示分析结果 -->
                                                    <el-collapse v-model="activeCollapse" accordion>
                                                        <!-- 主要分析结果 -->
                                                        <el-collapse-item title="主要分析结果" name="main">
                                                            <div v-html="formatContent(message.analysisResult.explanation || message.analysisResult.reason || '')"></div>
                                                        </el-collapse-item>
                                                        
                                                        <!-- 根本原因分析 -->
                                                        <el-collapse-item v-if="message.analysisResult.rootCauseAnalysis" title="根本原因分析" name="rootCause">
                                                            <div class="analysis-content" v-html="formatContent(message.analysisResult.rootCauseAnalysis)"></div>
                                                        </el-collapse-item>
                                                        
                                                        <!-- 代码修复建议 -->
                                                        <el-collapse-item v-if="message.analysisResult.codeFixSuggestion" title="代码修复建议" name="codeFix">
                                                            <div class="analysis-content code-fix" v-html="formatContent(message.analysisResult.codeFixSuggestion)"></div>
                                                        </el-collapse-item>
                                                        
                                                        <!-- 解决方案 -->
                                                        <el-collapse-item v-if="message.analysisResult.solution" title="解决方案" name="solution">
                                                            <div class="analysis-content" v-html="formatContent(message.analysisResult.solution)"></div>
                                                        </el-collapse-item>
                                                        
                                                        <!-- 预防措施 -->
                                                        <el-collapse-item v-if="message.analysisResult.prevention" title="预防措施" name="prevention">
                                                            <div class="analysis-content" v-html="formatContent(message.analysisResult.prevention)"></div>
                                                        </el-collapse-item>
                                                    </el-collapse>
                                                </div>
                                            </div>
                                        </div>
                                    </el-col>
                                </el-row>
                            </el-card>
                        </transition-group>
                            
                        <!-- 分页控件 -->
                        <div class="pagination-container" v-if="filteredMessages.length > pageSize">
                            <el-pagination
                                layout="prev, pager, next"
                                :total="filteredMessages.length"
                                :page-size="pageSize"
                                :current-page="currentPage"
                                @current-change="handlePageChange"
                                background
                            ></el-pagination>
                        </div>
                        </template>
                        
                        <!-- 无匹配搜索结果提示 -->
                        <div v-if="messages.length > 0 && searchQuery && filteredMessages.length === 0" class="empty-container">
                            <i class="el-icon-search empty-icon"></i>
                            <p>未找到匹配的消息</p>
                            <p style="margin-top: 10px; font-size: 14px;">
                                搜索"{{ searchQuery }}"没有找到结果
                                <el-button type="text" @click="clearSearch">清除搜索</el-button>
                            </p>
                        </div>
                        
                        <!-- 无筛选结果提示 -->
                        <div v-else-if="messages.length > 0 && !selectedMessageTypes.includes('all') && filteredMessages.length === 0" class="empty-container">
                            <i class="el-icon-warning empty-icon"></i>
                            <p>当前筛选条件下没有消息</p>
                            <p style="margin-top: 10px; font-size: 14px;">
                                当前选择的消息类型下没有匹配的消息
                                <el-button type="text" @click="resetTypeFilters">重置筛选</el-button>
                            </p>
                        </div>
                        
                        <!-- 无消息提示 -->
                        <div v-else-if="messages.length === 0" class="empty-container">
                            <i class="el-icon-message empty-icon"></i>
                            <p>暂无消息</p>
                            <p style="margin-top: 10px; font-size: 14px;">
                                等待接收Sentry消息...
                                <br><br>
                                <el-button type="primary" size="small" @click="runTestMessages">
                                    <i class="el-icon-video-play"></i> 发送测试消息
                                </el-button>
                            </p>
                        </div>
                    </div>
                
            </div>
        </main>
        
        <!-- 对话框组件 -->
        <!-- 消息详情对话框 -->
        <el-dialog
            v-model="showInfoDialog"
            title="消息存储信息"
            width="500px"
            align-center
            destroy-on-close
        >
            <div class="info-dialog-content" v-if="messageInfo">
                <h3>当前存储情况:</h3>
                <ul>
                    <li><b>消息总数:</b> {{ messages.length }} 条</li>
                    <li><b>当前文件:</b> {{ messageInfo.currentFile?.name || '未知' }}</li>
                    <li><b>文件大小:</b> {{ messageInfo.currentFile?.size || '0 KB' }}</li>
                    <li><b>最后更新:</b> {{ messageInfo.currentFile?.lastModified ? formatTime(messageInfo.currentFile.lastModified) : '未知' }}</li>
                </ul>
                <h3>存储设置:</h3>
                <ul>
                    <li><b>消息保存间隔:</b> {{ messageInfo.saveInterval || '未知' }}</li>
                    <li><b>自动保存:</b> {{ messageInfo.autoSave ? '开启' : '关闭' }}</li>
                </ul>
            </div>
            <template #footer>
                <span class="dialog-footer">
                    <el-button @click="showInfoDialog = false">关闭</el-button>
                </span>
            </template>
        </el-dialog>
        
        <!-- 清空消息确认对话框 -->
        <el-dialog
            v-model="showClearDialog"
            title="清空消息确认"
            width="500px"
            align-center
            destroy-on-close
        >
            <div class="dialog-content">
                <p>当前存储情况:</p>
                <ul>
                    <li>消息总数: {{ messages.length }} 条</li>
                    <li>当前文件: {{ messageInfo?.currentFile?.path ? messageInfo.currentFile.path.split('/').pop() : '未知' }}</li>
                    <li>文件大小: {{ messageInfo?.currentFile?.size || '0 KB' }}</li>
                    <li>最后更新: {{ messageInfo?.currentFile?.modified || '未知' }}</li>
                </ul>
                <p class="warning-text">确定要清空所有消息吗？此操作不可撤销。</p>
            </div>
            <template #footer>
                <div class="dialog-footer">
                    <el-button @click="showClearDialog = false">取消</el-button>
                    <el-button type="danger" @click="confirmClearAllMessages">确定清空</el-button>
                </div>
            </template>
        </el-dialog>
        
        <!-- 信息类型消息分析确认对话框 -->
        <el-dialog
            v-model="showAnalysisConfirmDialog"
            title="确认分析"
            width="500px"
            align-center
            destroy-on-close
        >
            <div class="dialog-content">
                <p>确定要对该信息类型消息进行AI分析吗？</p>
                <p>AI分析会生成对消息内容的解释和建议。</p>
            </div>
            <template #footer>
                <div class="dialog-footer">
                    <el-button @click="cancelAnalysis">取消</el-button>
                    <el-button type="primary" @click="confirmAnalysis">确认分析</el-button>
                </div>
            </template>
        </el-dialog>
        
        <!-- 批量分析进度对话框 -->
        <el-dialog
            v-model="showBatchAnalysisDialog"
            title="批量分析进度"
            width="500px"
            align-center
            destroy-on-close
            :close-on-click-modal="false"
            :show-close="false"
            :close-on-press-escape="false"
        >
            <div class="dialog-content">
                <p>已完成分析: {{ selectedMessages.filter(m => m.analysisResult).length }}/{{ selectedMessages.length }}</p>
                <p>分析过程将依次处理选中的消息，请耐心等待...</p>
                <div class="progress-container">
                    <el-progress :percentage="(selectedMessages.filter(m => m.analysisResult).length / selectedMessages.length) * 100"></el-progress>
                </div>
            </div>
        </el-dialog>
        
        <!-- API配置对话框 -->
        <el-dialog
            v-model="showApiConfigDialog"
            title="配置DeepSeek API"
            width="500px"
            align-center
            destroy-on-close
        >
            <div class="dialog-content">
                <p>配置DeepSeek API密钥，启用强大的AI分析功能</p>
                <div class="api-status">
                    <p><strong>API状态:</strong> 
                        <el-tag :type="apiConfigStatus.isConfigured ? 'success' : 'warning'">
                            {{ apiConfigStatus.isConfigured ? '已配置' : '未配置' }}
                        </el-tag>
                    </p>
                    <p v-if="apiConfigStatus.isConfigured" class="status-message success">
                        DeepSeek API已成功配置，AI分析功能已激活
                    </p>
                    <p v-else class="status-message warning">
                        尚未配置DeepSeek API，AI分析将使用本地模拟数据
                    </p>
                </div>
                <div class="api-form">
                    <el-form>
                        <el-form-item label="API密钥">
                            <el-input 
                                v-model="apiConfig.apiKey"
                                placeholder="输入以sk-开头的DeepSeek API密钥"
                                type="password"
                                show-password
                            ></el-input>
                            <div class="form-hint">DeepSeek API密钥用于启用智能分析功能，请从DeepSeek官方网站获取API密钥。</div>
                        </el-form-item>
                    </el-form>
                </div>
            </div>
            <template #footer>
                <div class="dialog-footer">
                    <el-button @click="showApiConfigDialog = false">取消</el-button>
                    <el-button 
                        type="primary" 
                        @click="saveApiConfig"
                        :loading="isUpdatingApiConfig"
                        :disabled="!apiConfig.apiKey || isUpdatingApiConfig"
                    >保存配置</el-button>
                </div>
            </template>
        </el-dialog>
    </div>
    
    <!-- 确保Vue应用程序正确初始化 -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        if (typeof Vue === 'undefined' || typeof ElementPlus === 'undefined') {
            console.error('Vue或ElementPlus未加载，尝试重新加载页面...');
            setTimeout(function() {
                window.location.reload();
            }, 3000);
        } else {
            console.log('Vue和ElementPlus已成功加载，初始化应用...');
        }
    });
    </script>
    
    <!-- 加载应用程序脚本 -->
    <script src="app.js"></script>
</body>
</html> 